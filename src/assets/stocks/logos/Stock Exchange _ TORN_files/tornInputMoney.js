;(function($,window,document,undefined){'use strict';var pluginName='tornInputMoney';function Plugin(element,options){var el=element;var $el=$(element);$.fn[pluginName].defaults={version:"1.0",symbol:'$',showSymbolButton:true,errorClass:'error',successClass:'success',groupMoneyClass:'input-money-group',symbolMoneyClass:'input-money-symbol',inputMoneyClass:'input-money',inputHiddenMoneyClass:'',buttonElement:$('.torn-btn'),buttonDisabledClass:'disabled',buttonDisabledAttribute:'disabled',moneySourceData:'data-money',title:"Click here to add the maximum amount, or use shortcuts like <br /> 5k, 1.5m, max, half, quarter, 1/2, 1/3, 1/4, 25%",strictMode:true,ajaxAction:null,disabled:false,disabledAutoCorrect:true,allowNegativeNumbers:false,onInit:function(){},onDestroy:function(){}};options=$.extend({},$.fn[pluginName].defaults,options);var reNumsSign=options.allowNegativeNumbers?'[-]?':'';var rules={digit:function(value){var re=new RegExp('^('+reNumsSign+'[1-9]\\d*)$','i');var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);return(inputMatch)?inputMatch[1]:null;},float:function(value){var re=new RegExp('^('+reNumsSign+'[1-9]\\d*(?:[,]\\d{3})*)(?:[.]\\d{10})?$','i');var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);return(inputMatch)?inputMatch[1]:null;},all:function(value){var re=/^(all|max){1}$/i;var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);var moneySourceData=$el.attr(options.moneySourceData);return(inputMatch&&moneySourceData)?moneySourceData:null;},thousand:function(value){var re=new RegExp('^('+reNumsSign+'\\d+[.]?(\\d{1,3})?)k$','i');var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);return(inputMatch)?Math.round(inputMatch[1]*1000):null;},million:function(value){var re=new RegExp('^('+reNumsSign+'\\d+[.]?(\\d{1,6})?)m$','i');var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);return(inputMatch)?Math.round(inputMatch[1]*1000000):null;},billion:function(value){var re=new RegExp('^('+reNumsSign+'\\d+[.]?(\\d{1,9})?)b$','i');var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);return(inputMatch)?Math.round(inputMatch[1]*1000000000):null;},quarter:function(value){var re=/^(1\/4|quarter){1}$/i;var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);var moneySourceData=$el.attr(options.moneySourceData);return(inputMatch&&moneySourceData)?Math.round(parseInt(moneySourceData)/4):null;},third:function(value){var re=/^(1\/3){1}$/i;var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);var moneySourceData=$el.attr(options.moneySourceData);return(inputMatch&&moneySourceData)?Math.round(parseInt(moneySourceData)/3):null;},half:function(value){var re=/^(1\/2|half){1}$/i;var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);var moneySourceData=$el.attr(options.moneySourceData);return(inputMatch&&moneySourceData)?Math.round(parseInt(moneySourceData)/2):null;},percent:function(value){var re=/^([1-9][0-9]?|100)%$/i;var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);var moneySourceData=$el.attr(options.moneySourceData);return(inputMatch&&moneySourceData)?Math.round(parseInt(moneySourceData)*inputMatch[1]/100):null;},firstZero:function(value){var re=/^([0])/i;var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);var limitAttr=$el.attr(options.moneySourceData);var limitValue=limitAttr?parseInt(limitAttr.replace(/,/g,'')):null;return(inputMatch&&limitValue==0)?inputMatch[1]:null;},zero:function(value){var re=/^([0])$/i;var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);return(inputMatch&&!options.strictMode)?inputMatch[1]:null;},fraction:function(value){var re=/^(([1-9])\/([2-9]|10))$/i;var inputValue=value||$el.val();var inputMatch=re.exec(inputValue);var moneySourceData=$el.attr(options.moneySourceData);return(inputMatch&&moneySourceData&&(parseInt(inputMatch[2])<parseInt(inputMatch[3])))?Math.round(parseInt(moneySourceData)*inputMatch[2]/inputMatch[3]):null;}};function init(){return $el.each(function(){var $input=$(this);var isDisabled=$input.attr('disabled')||options.disabled;$input.attr('disabled',isDisabled);if(isDisabled){$input.attr('readonly',true);}
if(options.disabledAutoCorrect){$input.attr('autocomplete','off');$input.attr('autocorrect','off');$input.attr('autocapitalize','off');$input.attr('spellcheck','false');}
var symbolWrapElement=$('<span/>').attr('title',options.title).addClass(options.symbolMoneyClass).html(options.symbol);var groupWrapElement=$('<div/>').addClass(options.groupMoneyClass+(isDisabled?' disabled':''));var parent=$input.wrap(groupWrapElement).parent();$input.addClass(options.inputMoneyClass);var $hiddenInput=$input.clone();$hiddenInput.attr('type','hidden');$input.after($hiddenInput);$hiddenInput.addClass(options.inputHiddenMoneyClass);$input.attr('name',null);var moneySourceDataValue=$input.attr(options.moneySourceData);if(moneySourceDataValue){$input.attr(options.moneySourceData,moneySourceDataValue.replace(/([,\.])/g,''));if(options.showSymbolButton){symbolWrapElement.prependTo(parent);}}else{parent.addClass('no-max-value');}
$input.on('formatted',function(event){$(this).trigger('change');});$input.on('click',function(event){formatter(event);});$input.on('blur',function(event){formatter(event);updateDataMoney(formatter);});$input.on('keypress',function(event){if(event.which===13){formatter(event);}});$input.on('keyup touchend',function(event){var val=$el.val();updateButtonElementState();updateErrorState();if(val){var re=new RegExp('('+reNumsSign+'[0-9,\\.]*)');var matches=re.exec(val);var isNumber=matches&&matches.input===matches[0];var intVal=parseInt(val.replace(/,/g,''));var limitAttr=$el.attr(options.moneySourceData);var limitValue=limitAttr?parseInt(limitAttr.replace(/,/g,'')):null;var limitValueIsExceeded=(limitValue&&(intVal>limitValue));if(!isNumber||limitValueIsExceeded){cursorPositionFormatter(event);if(limitValueIsExceeded){updateDataMoney(formatter);}}}else{$el.closest('.'+options.groupMoneyClass).removeClass(options.successClass);$el.closest('.'+options.groupMoneyClass).removeClass(options.errorClass);}
if(val=='0'||val==''){$el.next().val(val);}
formatter(event);var $groupMoney=$el.closest('.'+options.groupMoneyClass);hook('onAfterChange',{value:$el.val(),error:$groupMoney.hasClass(options.errorClass)});cursorPositionFormatter(event);});$input.on('keydown',function(event){cursorPositionFormatter(event);});$input.on('select',function(event){cursorPositionFormatter(event);});$input.closest('.'+options.groupMoneyClass).find('.'+options.symbolMoneyClass).on('click',function(event){if(isDisabled){return;}
if(options.ajaxAction){updateDataMoney(function(){$input.val('max');formatter(event);hook('onAfterMoneyUpdate');});}else{$input.val('max');updateDataMoney();formatter(event);hook('onAfterMoneyUpdate');}});if($input.val()){formatter();}
else{options.buttonElement&&options.buttonElement.addClass(options.buttonDisabledClass);options.buttonElement&&options.buttonElement.prop(options.buttonDisabledAttribute,true);}
checkBrowserTabVisibility();hook('onInit');});}
function setCursorPosition(pos){$el.each(function(index,elem){if(elem.setSelectionRange){elem.setSelectionRange(pos,pos);}else if(elem.createTextRange){var range=elem.createTextRange();range.collapse(true);range.moveEnd('character',pos);range.moveStart('character',pos);range.select();}});}
function updateButtonElementState(){if(options.buttonElement){if($el.val()){options.buttonElement.removeClass(options.buttonDisabledClass);options.buttonElement.prop(options.buttonDisabledAttribute,false);}else{options.buttonElement.addClass(options.buttonDisabledClass);options.buttonElement.attr(options.buttonDisabledAttribute,true);}}}
function updateErrorState(){var $groupMoney=$el.closest('.'+options.groupMoneyClass);if($el.val()){$groupMoney.removeClass(options.errorClass);}}
function getCursorPosition(){var pos=0;var elem=$el.get(0);if(document.selection){elem.focus();var Sel=document.selection.createRange();var SelLength=document.selection.createRange().text.length;Sel.moveStart('character',-elem.value.length);pos=Sel.text.length-SelLength;}
else if(elem.selectionStart||elem.selectionStart=='0')
pos=elem.selectionStart;return pos;}
function getSelectionLength(){var start=0,end=0,normalizedValue,range,textInputRange,len,endRange;if(typeof el.selectionStart=="number"&&typeof el.selectionEnd=="number"){start=el.selectionStart;end=el.selectionEnd;}else{range=document.selection.createRange();if(range&&range.parentElement()==el){len=el.value.length;normalizedValue=el.value.replace(/\r\n/g,"\n");textInputRange=el.createTextRange();textInputRange.moveToBookmark(range.getBookmark());endRange=el.createTextRange();endRange.collapse(false);if(textInputRange.compareEndPoints("StartToEnd",endRange)>-1){start=end=len;}else{start=-textInputRange.moveStart("character",-len);start+=normalizedValue.slice(0,start).split("\n").length-1;if(textInputRange.compareEndPoints("EndToEnd",endRange)>-1){end=len;}else{end=-textInputRange.moveEnd("character",-len);end+=normalizedValue.slice(0,end).split("\n").length-1;}}}}
return end-start;}
function cursorPositionFormatter(event){var elem=$el.get(0);if(event.which==65||event.which==17&&!event.ctrlKey||(event.which==91||event.which==224)&&!event.metaKey){return false;}
switch(event.type){case 'select':$.data($el,'selection_length',getSelectionLength());break;case 'keydown':$.data($el,'old_position',getCursorPosition());$.data($el,'old_length',elem.value.length);break;case 'keyup':if(event.which!=16&&event.which!=35&&event.which!=36&&event.which!=37&&event.which!=39){var offset=$.data($el,'selection_length')||0;var oldFromEndPosition=$.data($el,'old_length')-$.data($el,'old_position');formatter(event);if(event.which===46){offset=($.data($el,'selection_length'))?$.data($el,'selection_length'):1;}
var currentPositionCursor=elem.value.length-oldFromEndPosition+offset;setCursorPosition((currentPositionCursor<0)?0:currentPositionCursor);$.data($el,'selection_length',0);}
break;}}
function checkBrowserTabVisibility(){$(window).focus(function(){});}
function updateDataMoney(callback){if(options.ajaxAction){$.ajax({method:"POST",url:addRFC(options.ajaxAction),success:function(data){var formattedData=hook('onMoneyUpdate',data)||data;$el.attr(options.moneySourceData,formattedData);$el.next().filter('input[type="hidden"].'+options.inputMoneyClass).attr(options.moneySourceData,formattedData);if(callback&&typeof(callback)==='function'){callback();}}});}}
function option(key,val){if(val){options[key]=val;}else{return options[key];}}
function destroy(){$el.each(function(){var el=this;var $el=$(this);var $clonedEl=$el.clone();var $parent=$el.parent();$clonedEl.removeClass(options.inputMoneyClass);$parent.before($clonedEl);$el.parent().remove();hook('onDestroy');$el.removeData('plugin_'+pluginName);});}
function hook(hookName,args){var arg=args||{};if(options[hookName]!==undefined){return options[hookName].call(el,arg);}}
function formatter(event){var result;var inputValue=$el.val().replace(/,/g,'');$.each(rules,function(rulename,method){inputValue=$.trim(inputValue);result=method.call(this,inputValue);if(result||result==0){var intValue=parseInt(result.toString().replace(/,/g,''));var limitAttr=$el.attr(options.moneySourceData);var limitValue=limitAttr?parseInt(limitAttr.replace(/,/g,'')):null;if((limitValue||limitValue==0)&&intValue>=limitValue){intValue=limitValue;}
inputValue=intValue.toString().replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g,'$1,');$el.next().val(intValue);return false;}});if($el.val()!=inputValue){$el.val(inputValue);}
var $groupMoney=$el.closest('.'+options.groupMoneyClass).removeClass(options.successClass).removeClass(options.errorClass);var $button=options.buttonElement;if(result&&(result!=0||!options.strictMode)){$groupMoney.addClass(options.successClass);$button&&$button.removeClass(options.buttonDisabledClass);$button&&$button.prop(options.buttonDisabledAttribute,false);$el.trigger('formatted');}
else if(inputValue.length>0){$groupMoney.addClass(options.errorClass);$button&&$button.addClass(options.buttonDisabledClass);$button&&$button.prop(options.buttonDisabledAttribute,true);}}
function addRules(nameRules,actionRules){var customRules={};var $el=$el;customRules[nameRules]=actionRules;rules=$.extend(rules,customRules);}
init();return{option:option,destroy:destroy,addRules:addRules};}
$.fn[pluginName]=function(options){if(typeof arguments[0]==='string'){var methodName=arguments[0];var args=Array.prototype.slice.call(arguments,1);var returnVal;this.each(function(){if($.data(this,'plugin_'+pluginName)&&typeof $.data(this,'plugin_'+pluginName)[methodName]==='function'){returnVal=$.data(this,'plugin_'+pluginName)[methodName].apply(this,args);}else{throw new Error('Method '+methodName+' does not exist on jQuery.'+pluginName);}});if(returnVal!==undefined){return returnVal;}else{return this;}}else if(typeof options==="object"||!options){return this.each(function(){if(!$.data(this,'plugin_'+pluginName)){$.data(this,'plugin_'+pluginName,new Plugin(this,options));}});}};})(jQuery,window,document);