jQuery(function(){var factionSearchDelay;var $header=$('.header');var $body=$('body');var $tcClock=$header.find('.tc-clock');var $recentHistoryWrapper=$header.find('.recently-history');var isCheckUserStatusInProgress=false;function checkUserJailHospitalStatus(){isCheckUserStatusInProgress=true;var stamp=0,isJail='';if($header.attr('data-jail')){stamp=$header.attr('data-jail');isJail=true;}else{stamp=$header.attr('data-hospital');isJail=false;}
if(stamp){var timeOutLimit=stamp*1000-$.now();if(timeOutLimit>0){setTimeout(function(){if(stamp*1000<$.now()){var action=document.location.protocol+
'//'+document.location.hostname+
'/'+(isJail?'hospitalview.php?action=hospitalStatus':'jailview.php?action=jailStatus');$.ajax({type:"POST",url:addRFC(action),success:function(data){var status=$.parseJSON(data);if(status.timestamp){checkUserJailHospitalStatus();}else{var msg='You are now out of '+(isJail?'jail':'hospital');var $tutoriaCcont=$('.tutorial-cont');var $elementAppendAfter=null;if($tutoriaCcont.length){$elementAppendAfter=$tutoriaCcont;}else{$elementAppendAfter=$('.content-title');}
informationMessageTemplate($elementAppendAfter,false,true,'green');$elementAppendAfter.next().hide().find('.msg').empty().text(msg).end().slideDown();getSearchTypeHTML();}
isCheckUserStatusInProgress=false;getSearchTypeHTML();}});}},timeOutLimit);}}}
if(!isCheckUserStatusInProgress){checkUserJailHospitalStatus();}
$(window).focus(function(e){if(!isCheckUserStatusInProgress){checkUserJailHospitalStatus();}});$header.on('click','.forgot-wrap .forgot input',function(){$header.find('.header-menu, .header-navigation').fadeOut(500,function(){$header.find('.forgot-pass-msg').fadeIn(500,function(){$header.addClass('forgot-pass');$header.find('.header-menu, .header-navigation, .forgot-pass-msg').removeAttr('style');});});});$header.on('click','.forgot-pass-msg .close-icon',function(){$header.find('.forgot-pass-msg').fadeOut(500,function(){$header.removeClass('forgot-pass');$header.find('.header-menu, .header-navigation').fadeIn(500,function(){$header.find('.header-menu, .header-navigation, .forgot-pass-msg').removeAttr('style');});});});function initSelectMenu(selectors){$(selectors).selectmenu({positionOptions:{collision:"none",},open:function(){$(this).parents('.select-wrapper').addClass('active');},close:function(){$(this).parents('.select-wrapper').removeClass('active');}});}
initSelectMenu('#search-type');function restoreAdvancedSearchCondition(){var userID=$.cookie().uid;var storedFormData=localStorage.getItem('advancedSearchCondition_'+userID);if(null!==storedFormData){storedFormData=JSON.parse(storedFormData);$(storedFormData).each(function(index,inputData){var $input=$('.advanced-search [name="'+inputData.name+'"]');var inputValue=inputData.value;if($input.is('input:not([type="checkbox"])')){$input.attr('value',inputValue);}else if($input.is('select')){$input.find('option[value="'+inputValue+'"]').attr('selected','selected');}else if($input.is('[type="checkbox"]')){inputValue=='on'?$input.attr('checked','checked'):'';}});}}
restoreAdvancedSearchCondition();var selectFields='#search-gender, #search-status, #search-property, #search-online, #search-condition';if(!isTouchDevice()){initSelectMenu(selectFields);}
else{var $findSelectWrapper=$('.find-extend').find('.select-wrapper');$('.find-extend').addClass('native-dropdown');$findSelectWrapper.find('.section-l').hide();$findSelectWrapper.find('.section-r').hide();}
$('.form-search-extend input[type="reset"]').click(function(){$('.find-extend input:not([name="sid"])').val('').removeAttr("value").removeAttr("checked");$(selectFields).each(function(i,e){$(e).selectmenu("value",'');$(e).find('option').removeAttr("selected");});localStorage.removeItem('advancedSearchCondition_'+$.cookie().uid);});$('.form-search-extend').on('submit',function(event){event.preventDefault();var $form=$(event.target);var formData=$form.serializeArray();var formDataJson=JSON.stringify(formData);var userID=$.cookie().uid;var factionName=$form.find('#search-faction').val();var factionID=$form.find('input[name="factionID"]').val();if(factionName&&!factionID){return;}
var query=$form.serializeArray().filter(function(i){return i.value;});localStorage.setItem('advancedSearchCondition_'+userID,formDataJson);window.location.href=$form.attr('action')+(query?'?'+$.param(query):'');});$('#search-condition, #search-condition-not').on('change',function(){var $factionSection=$('.form-search-extend input[name="faction"]').closest('li');var selectedValue=$('#search-condition').val();var isNotOptionSelected=$('#search-condition-not').prop('checked');if(selectedValue=='inFaction'&&isNotOptionSelected){$factionSection.hide().find('input[name="faction"]').val('').prop('disabled',true);}else{$factionSection.show().find('input[name="faction"]').prop('disabled',false);}});initiateNativeMobileDropList($('#search-type'),'.select-wrapper');var pcelem=$('input.radio');if(pcelem.get(0)){pcelem.prettyCheckable();}
$('input[placeholder]').placeholder();function setLogoDataCookie(logoNumber,logoTime){var logoPreferences={number:logoNumber,time:logoTime};if(!$.cookie('logoData')){$.cookie('logoData',JSON.stringify(logoPreferences),{expires:18262});}else{$.cookie('logoData',JSON.stringify(logoPreferences));}}
var $logo=$(".torn-birthday");var isMobileLogoActive=false;$(window).on('resize',function(){if(getBrowserWidth()<=minTabletSize&&!isMobileLogoActive){mobileBirthdayLogo();isMobileLogoActive=true;}
if(getBrowserWidth()>minTabletSize&&isMobileLogoActive){isMobileLogoActive=false;}});if(isMobileMedia()){mobileBirthdayLogo();}
function mobileBirthdayLogo(){$logo.find('.logo').off('click.birthdayZoomIn').on('click.birthdayZoomIn',function(){$logo.find('.logo a').addClass('unscaled').focus()});$logo.find('.logo a').blur(function(){$(this).removeClass('unscaled');});}
if($logo.length){var letterUsed='letter-used',letterTime='letter-timeout';$logo.find('.letters > div').on('click',function(e){e.preventDefault();var $it=$(this);var $letter=$it.find('.letter'),letterName=$it.data('letter'),bonusNotification=$it.find('.bonus'),used=parseInt($letter.attr(letterUsed)),timeout=parseInt($letter.attr(letterTime)),currentTime=parseInt((new Date().getTime())/1000)-1,usedClass=letterName+'-used-'+used;if(used>=10||used<0){return}
if(currentTime>=timeout){$it.addClass('scaled');getAction({action:'birthday.php',type:'post',data:{step:'eatLetter',eat:letterName},success:function(response){if(response.success){var nextClass=letterName+'-used-'+response.used;$letter.removeClass(usedClass).addClass(nextClass).attr(letterUsed,response.used).attr(letterTime,response.timeout);bonusNotification.show().addClass('appeared');}
$it.removeClass('scaled');setTimeout(function(){bonusNotification.hide().removeClass('appeared')},1000);}});}})}
var searchBox=$('.input-wrapper.search, .find input.search, .search-type-radio');function closeAdditionalSearch(selector){$('.search-mobile-button').removeClass('collapsed');selector.removeClass('visible');}
$('.search-mobile-button').click(function(){var $el=$(this);if($el.hasClass('collapsed')){closeAdditionalSearch(searchBox);}else{$el.addClass('collapsed');searchBox.addClass('visible');$('.find-extend').removeClass('open');$header.find('.avatar').removeClass('active');closeRecentHistory();}
if(getBrowserWidth()<=maxTabletSize){$('.header-menu').removeClass('active');}});function msgFlexSlider(){$('.flexslider').flexslider({selector:'.slides a',animation:"slide",controlNav:false,maxItems:1});};var newsSlides=$('.flexslider .slides a');if(newsSlides.length>1){msgFlexSlider();}
$('.find-extend .button').click(function(e){e.preventDefault();var $findExtend=$(this).closest('.find-extend');$findExtend.toggleClass('open');if($findExtend.hasClass('open')){closeAdditionalSearch(searchBox);$header.find('.avatar').removeClass('active');closeRecentHistory();}
if(getBrowserWidth()<=maxTabletSize){$('.header-menu').removeClass('active');}});$('.header-menu .header-menu-icon').click(function(){var isUserLoggedOut=$('.header').hasClass('logged-out');if(getBrowserWidth()<=maxTabletSize||(isUserLoggedOut&&getBrowserWidth()<maxTabletSize)){$(this).closest('.header-menu').toggleClass('active');closeAdditionalSearch(searchBox);$('.find-extend').removeClass('open');$header.find('.avatar').removeClass('active');if(!isUserLoggedOut){closeRecentHistory();}}});function toggledHeaderForms(selector,forms){$(selector).click(function(){$(forms).toggle();});}
toggledHeaderForms('#linkforgot, #linkreturnlogin','.log-in-wrap, .forgot-wrap');var searchTypeButton=$('#search-type-button');searchTypeButton.hide();searchTypeButton.fadeIn(1500);var $searchType=$('#search-type');$searchType.selectmenu({change:function(){var searchType=$(this).val();if(searchType=='userID'){jQuery('#searchForm').get(0).setAttribute('action','/profiles.php');jQuery('#userword').attr('name','XID');}
else if(searchType=='forum'){jQuery('#searchForm').get(0).setAttribute('action','/forums.php');jQuery('#userword').attr('name','searchword');}
else if(searchType=='wiki'){jQuery('#searchForm').get(0).setAttribute('action','/wiki/index.php');jQuery('#userword').attr('name','search');}
else{jQuery('#searchForm').get(0).setAttribute('action','/search.php');jQuery('#userword').attr('name','userword');}}});$header.on('change','.search-type-radio input[name="search-type"]',function(event){var indexUserSearchType=$('.search-type-radio input[name="search-type"]').index($('input[name="search-type"]:checked'));changeSearchType(indexUserSearchType);});$header.on('focus','#searchForm #userword',function(){var userSearchType=($.cookie('userSearchType')!==undefined)?$.cookie('userSearchType'):0;var $searchTypeRadio=$('.search-type-radio .choice-container .radio-css');changeSearchType(userSearchType);$searchTypeRadio.prop('checked',false);$searchTypeRadio.eq(userSearchType).prop('checked',true);});function changeSearchType(indexUserSearchType){$searchType.find('option').eq(indexUserSearchType).prop('selected',true);$searchType.selectmenu();$searchType.change();}
function loadCookieSearchType(){if($.cookie('userSearchType')){changeSearchType($.cookie('userSearchType'));}}
$searchType.change(function(){var $userSearchTypeSelected=$searchType.find("option:selected");var indexUserSearchType=$userSearchTypeSelected.index();if(indexUserSearchType!=$.cookie('userSearchType')){var dateSearch=new Date();var lifeTimeSearchCookie=10;dateSearch.setTime(dateSearch.getTime()+(lifeTimeSearchCookie*60*1000));$.cookie('userSearchType',indexUserSearchType,{expires:dateSearch});}
if($userSearchTypeSelected.attr('data-minlength')){$('.header .search-text').val('');}});loadCookieSearchType();$('#searchForm').submit(function(){$('.search-text, select.search-type').trigger('blur');var form=$(this);var action=form.attr('action');var userword=form.find('#userword').val();var searchType;searchType=form.find('#search-type').val();if(searchType=='forum'){location='/forums.php#!p=search&f=0&y=0&q='+userword;}
else if(searchType=='player'||searchType=='user-name'){var regex=/([^(\[\])]+)(\[(\d+)\])*/i;var match=regex.exec(userword);if(match){location=(match[3])?'/profiles.php?XID='+match[3]:'/page.php?sid=UserList&playername='+match[1];}
else{location='/page.php?sid=UserList&playername='+userword;}}
else if(searchType=='faction'||searchType=='faction-name'){location='/factions.php?step=listing&q='+userword;}
else if(searchType=='company'||searchType=='company-name'){location='/joblist.php?step=search#/p=search&q='+userword;}
else if(searchType=='wiki'||searchType=='help-wiki'){jQuery('#searchForm').get(0).setAttribute('action','/wiki/index.php');jQuery('#userword').attr('name','search');return true;}
return false;});$header.on('submit','#frmResend',function(event){event.preventDefault();var $this=$(this);$header.find('.pass-msg').html('').next().addClass('hide');ajaxWrapper({url:$this.attr('action'),dataType:'json',type:'post',data:$this.serializeArray(),oncomplete:function(response){var resp=response.responseText;$header.find('.forgot-pass-msg').removeClass('success error').addClass(resp.success?'success':'error').find('.pass-msg').html(resp.msg).next().removeClass('hide');}});});var factionSearchSelectHandler=function(e){var $selectedFaction=$(e.target);var $searchFieldWrapper=$selectedFaction.closest('.factionField');var $factionInput=$searchFieldWrapper.find('input[name="faction"]');var $factionIdInput=$searchFieldWrapper.find('input[name="factionID"]');var selectedFactionID=$selectedFaction.attr('data-factionId');var factionName=$selectedFaction.find('.factionNamePart').text();$factionInput.val(factionName);$factionIdInput.val(selectedFactionID);$searchFieldWrapper.removeClass('opened');};var factionSearchHandler=function(factionsList){var $factionList=$('.advanced-search .factionsList');var $searchFieldWrapper=$factionList.closest('.factionField');var $factionIdInput=$factionList.siblings('input[name="factionID"]');var $factionInput=$factionList.siblings('#search-faction');$factionList.empty();$factionIdInput.val('');if($factionInput.val().length===0){$searchFieldWrapper.removeClass('opened');return;}else if(factionsList.length===0){$factionList.html('<li class="noResults">No results</li>');}
$(factionsList).each(function(index,factionData){var $element=$('<li></li>');$('<span></span>').addClass('factionNamePart').text(factionData.name).appendTo($element);$('<span></span>').addClass('factionRespectPart').text('respect:'+factionData.respect).appendTo($element);$element.attr('data-factionId',factionData.id).appendTo($factionList);$element.click(factionSearchSelectHandler);});$searchFieldWrapper.addClass('opened');};$header.on('input','.advanced-search input[name="faction"]',function(event){var $this=$(this);var value=$this.val();var searchData={'option':'faction','q':value};clearTimeout(factionSearchDelay);factionSearchDelay=setTimeout(function(){if(value.length>0){$this.addClass('loading');ajaxWrapper({url:'autocompleteHeaderAjaxAction.php',dataType:'json',type:'post',data:searchData,oncomplete:function(response){$this.removeClass('loading');factionSearchHandler(response.responseText.list)}});}else{factionSearchHandler([])}}.bind(this),300);});$header.on('keydown','.advanced-search input[type="number"]',function(event){if(event.key.length===1&&/[^0-9]/g.test(event.key)){event.preventDefault();}});$header.on('keydown','.advanced-search input[type="text"]',function(event){var regex=/[\u0400-\u04FF]/g;if(event.key.length===1&&regex.test(event.key)){event.preventDefault();}});$header.on('blur','.advanced-search input[name="faction"]',function(){setTimeout(function(){$('.advanced-search .factionField').removeClass('opened');},300)});$header.on('click','#desktop-view-state',function(){var $body=$('body');$body.toggleClass('r');setSidebarStatesCookie(true);$body.empty();});var WEEK=7;$header.on('change','#dark-mode-state',function(){var isEnabledDarkMode=$body.hasClass('dark-mode');setCookie('darkModeEnabled',!isEnabledDarkMode,WEEK);$body.toggleClass('dark-mode');var celebration=$body.attr('data-celebration');var country=$body.attr('data-country');if(!isEnabledDarkMode){if(celebration==='none'&&country==='torn'){$body.attr('data-dark-mode-logo','regular');}}else{$body.removeAttr('data-dark-mode-logo');}});$header.on('click','.avatar .top_header_button',function(){var $settingsMenuWrap=$header.find('.avatar');$settingsMenuWrap.toggleClass('active');if($settingsMenuWrap.hasClass('active')){closeAdditionalSearch(searchBox);$('.find-extend').removeClass('open');closeRecentHistory();if(getBrowserWidth()<=maxTabletSize){$('.header-menu').removeClass('active');}}});$('.log-in .keep-me').prettyCheckable();WebsocketHandler.addEventListener('sidebar','onLeaveFromJail',function(){getSearchTypeHTML();});WebsocketHandler.addEventListener('sidebar','onRevive',function(){getSearchTypeHTML();});WebsocketHandler.addEventListener('sidebar','onHospital',function(){getSearchTypeHTML();});WebsocketHandler.addEventListener('sidebar','onJail',function(){getSearchTypeHTML();});WebsocketHandler.addEventListener('header','updateAvatar',function(data){var $avatar=$('.header .toolbar .avatar');if(data.image.isDefault){$avatar.addClass('default');}else{$avatar.removeClass('default');}
$('.header .avatar .mini-avatar-image').attr('src',data.image.link);});function getSearchTypeHTML(){var action=window.location.protocol+'//'+window.location.hostname+'/'+'autocompleteHeaderAjaxAction.php';var $searchTypeWrapper=$('#search-type-wrapper');}
function showTCClock(){$tcClock.addClass('active');$.cookie('tcClockEnabled',true,{expires:18262});}
function hideTCClock(){$tcClock.removeClass('active');$.cookie('tcClockEnabled',false,{expires:18262});}
if($tcClock.length){var $tcClockTooltip=$tcClock.find('.tc-clock-tooltip');var initialTopPosition=$tcClockTooltip.offset().top;var $mainContainer=$('#mainContainer');var mainContainerRightOffset=getRightOffset($mainContainer);var tcClockTooltipRightOffset=getRightOffset($tcClockTooltip);var rightOffsetDiff=tcClockTooltipRightOffset-mainContainerRightOffset;var $clockBtn=$tcClock.find('.button')
setTooltipPosition();initClock();$header.on('click','.tc-clock-tooltip',function(){return false;});$header.on('click','.tc-clock .button',function(e){e.preventDefault();if($tcClock.hasClass('active')){hideTCClock();}else{showTCClock();}});window.addEventListener('scroll',function(){setTooltipPosition();});$(window).resize(function(){setTooltipPosition();});function initClock(){var serverTimeBlock=$tcClockTooltip.find('.server-time');var serverDateBlock=$tcClockTooltip.find('.server-date');var start=Date.now()*1000;var week=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];var month=['Jan','Feb','Mar','Apr','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];ajaxWrapper({url:location.protocol+'//'+location.host+'/sidebarAjaxAction.php?action=servertime',oncomplete:function(resp){var time=resp&&resp.responseText&&JSON.parse(resp.responseText).time||0;start=time;setInterval(function(){var date=new Date(start);var h=formatNumber(date.getUTCHours());var m=formatNumber(date.getUTCMinutes());var s=formatNumber(date.getUTCSeconds());var d=formatNumber(date.getUTCDate());var mth=formatNumber(date.getUTCMonth()+1);var y=date.getUTCFullYear().toString().substr(2);var str=week[date.getUTCDay()]+' '+h+':'+m+':'+s;var waiDate=date.getUTCDate()+' '+month[date.getUTCMonth()]+' '+date.getUTCFullYear();var waiStr=str+'. Date: '+waiDate;serverTimeBlock.text(str);str='- '+d+'/'+mth+'/'+y;serverDateBlock.text(str);start+=1000;$clockBtn.attr('aria-label',waiStr);},1000);if($.cookie('tcClockEnabled')==='true'){$tcClock.addClass('active');}}});setInterval(function(){ajaxWrapper({url:location.protocol+'//'+location.host+'/sidebarAjaxAction.php?action=servertime',oncomplete:function(resp){var time=0
try{var timeIn=JSON.parse(resp.responseText).time
time=timeIn}catch(e){console.error('Some error happen during fetch',e)}
start=time;}});},60000);}
function formatNumber(num){return num<10?'0'+num:num;}
function getRightOffset($el){return $(window).width()-($el.offset().left+$el.outerWidth());}
function setTooltipPosition(){var scrollTop=$(window).scrollTop();if(scrollTop>initialTopPosition){$tcClock.addClass('sticky');if(isMobileMedia()){$tcClockTooltip.css('right','');}else{var right=getRightOffset($mainContainer)+rightOffsetDiff;$tcClockTooltip.css('right',right+'px');}}else{$tcClock.removeClass('sticky');$tcClockTooltip.css('right','');}}}
function closeRecentHistory(){if(window.unmountRecentHistory&&$recentHistoryWrapper){unmountRecentHistory();$recentHistoryWrapper.removeClass('open');}}
function openRecentHistory(){renderRecentHistory();$recentHistoryWrapper.addClass('open');}
$header.on('click','.recently-history .button',function(){if($recentHistoryWrapper.hasClass('open')){closeRecentHistory();}else{$(this).closest('.header-menu').removeClass('active');closeAdditionalSearch(searchBox);$('.find-extend').removeClass('open');$header.find('.avatar').removeClass('active');if(getBrowserWidth()<=maxTabletSize){$('.header-menu').removeClass('active');}
openRecentHistory();}});});